# 01. 認証システム概要

## 📋 概要

歴史的年表APIの認証・認可システムは、JWT（JSON Web Token）とAPIキー認証を組み合わせたハイブリッド認証システムです。ロールベースのアクセス制御（RBAC）を実装し、セキュリティと使いやすさを両立させています。

## 🎯 設計目標

### 1. セキュリティ要件
- **認証**: JWTによるステートレス認証 + APIキー認証
- **認可**: ロールベースのアクセス制御（user, moderator, admin）
- **セキュリティ**: パスワードハッシュ化、アカウントロック機能
- **監査**: ログイン履歴、アクセスログ

### 2. ユーザビリティ要件
- **シンプル**: 開発者にとって使いやすいAPI
- **柔軟**: 段階的な認証レベル（任意、必須、権限別）
- **拡張性**: 将来的な機能追加に対応

## 🏗️ アーキテクチャ

### 認証フロー

```
1. ミドルウェア（高速処理）
   ├── X-API-Key: 即座に検証
   └── JWT: 基本検証のみ

2. 依存性（詳細処理）
   ├── ユーザー存在確認
   ├── 権限チェック
   └── ビジネスロジック
```

### 認証方式の使い分け

#### APIキー認証（システム間通信）
- **用途**: バッチ処理、監視、サードパーティ統合
- **特徴**: 高速、軽量、グローバルアクセス
- **実装**: `app/dependencies/api_key_auth.py`

#### JWT認証（ユーザー認証）
- **用途**: ユーザー認証、権限ベース制御
- **特徴**: 細かい権限制御、ユーザー追跡
- **実装**: `app/dependencies/jwt_auth.py`

## 👥 ロール設計

### ロール階層
```
┌─────────────┐
│   Admin     │ ← 全権限
│   (Level 3) │
└─────────────┘
       │
       ▼
┌─────────────┐
│ Moderator   │ ← 編集権限
│ (Level 2)   │
└─────────────┘
       │
       ▼
┌─────────────┐
│    User     │ ← 閲覧権限
│ (Level 1)   │
└─────────────┘
```

### 権限マトリックス

| エンドポイント | User | Moderator | Admin |
|---------------|------|-----------|-------|
| GET /persons | ✅ | ✅ | ✅ |
| POST /persons | ❌ | ✅ | ✅ |
| PUT /persons | ❌ | ✅ | ✅ |
| DELETE /persons | ❌ | ❌ | ✅ |
| GET /users | ❌ | ❌ | ✅ |
| POST /users/*/activate | ❌ | ❌ | ✅ |

## 🔐 セキュリティ対策

### 1. トークンセキュリティ
- **署名**: HMAC-SHA256
- **有効期限**: アクセストークン30分、リフレッシュトークン7日
- **ペイロード**: ユーザーID、メール、ロール、発行時刻

### 2. パスワードセキュリティ
- **ハッシュ化**: bcrypt（コスト12）
- **ソルト**: 自動生成
- **検証**: タイミング攻撃対策

### 3. アカウント保護
- **ロック機能**: 5回失敗で30分ロック
- **自動解除**: 成功時リセット
- **監査ログ**: ログイン履歴

### 4. 入力検証
- **メール**: 形式検証
- **パスワード**: 強度チェック（8文字以上）
- **ユーザー名**: 文字数制限（3-50文字）
- **SQLインジェクション**: ORM使用

## 📊 パフォーマンス最適化

### 処理速度比較

| 認証方式 | ミドルウェア処理 | 依存性処理 | 合計 |
|---------|----------------|-----------|------|
| X-API-Key | ~0.1ms | ~0.1ms | ~0.2ms |
| JWT基本 | ~1ms | ~5ms | ~6ms |
| JWT詳細 | ~1ms | ~50ms | ~51ms |

### メモリ使用量
- **ミドルウェア**: 軽量（認証情報のみ保持）
- **依存性**: 必要時のみユーザーオブジェクト生成

## 🔄 認証フロー詳細

### 1. ユーザー登録
```
1. クライアント → API: POST /auth/register
2. API: メールアドレス・ユーザー名重複チェック
3. API: パスワードハッシュ化
4. API → Database: ユーザー作成
5. API → クライアント: ユーザー情報（パスワード除く）
```

### 2. ログイン
```
1. クライアント → API: POST /auth/login
2. API: ユーザー検索（メール/ユーザー名）
3. API: パスワード検証
4. API: 失敗回数チェック・アカウントロック
5. API: JWTトークン生成
6. API → クライアント: アクセストークン + リフレッシュトークン
```

### 3. APIアクセス
```
1. クライアント → API: リクエスト + Authorization Header
2. API: JWTトークン検証
3. API: ユーザー情報取得
4. API: 権限チェック
5. API: リクエスト処理
6. API → クライアント: レスポンス
```

## 📝 実装計画

### Phase 1: 基盤構築 ✅
- [x] ユーザーモデル作成
- [x] 認証スキーマ定義
- [x] JWTユーティリティ実装
- [x] データベースマイグレーション

### Phase 2: 認証機能 ✅
- [x] 認証依存性実装
- [x] 認証ルーター作成
- [x] ログイン・登録機能
- [x] トークン管理

### Phase 3: 認可機能 ✅
- [x] ロールベース制御
- [x] 権限チェック機能
- [x] エンドポイント保護
- [x] エラーハンドリング

### Phase 4: テスト・最適化 ✅
- [x] 認証テスト
- [x] 認可テスト
- [x] セキュリティテスト
- [x] パフォーマンス最適化

## 🔗 関連ドキュメント

- [02. データベース設計](./02-データベース設計.md)
- [03. API仕様書](./03-API仕様書.md)
- [04. シーケンス図](./04-シーケンス図.md)
- [05. 実装ガイド](./05-実装ガイド.md) 